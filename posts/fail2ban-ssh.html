
<!DOCTYPE html>
<html lang="es-es">

    <head>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta property="og:title" content=" Usando Fail2Ban para securizar SSH &middot;  Entre Dev y Ops" />
        <meta property="og:site_name" content="Entre Dev y Ops" />
        <meta property="og:url" content="http://www.entredevyops.es/posts/fail2ban-ssh.html" />

    
        <meta property="og:type" content="article" />
        <meta property="og:article:published_time" content="2016-09-08T15:30:00Z" />
        <meta property="og:article:tag" content="Fail2Ban" />
        <meta property="og:article:tag" content="SSH" />
        

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@entredevyops" />
        <meta name="twitter:creator" content="@entredevyops" />
        <meta name="twitter:title" content="Usando Fail2Ban para securizar SSH" />
        
        <meta name="twitter:description" content="

Hace poco realizando tareas de mantenimiento en mi servidor personal vi varios mensajes en los logs que no me gustaron nada: Failed password for root from 121.18.238.22 port 40618 ssh2.

Claramente mi servidor estaba bajo un ataque para conseguir acceso SSH.

" />
        <meta name="twitter:url" content="http://www.entredevyops.es/posts/fail2ban-ssh.html" />
    

        <title> Usando Fail2Ban para securizar SSH &middot;  Entre Dev y Ops</title>

        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js" integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>

        <link rel="preload" href="/js/main.js" as="script" />
        <link rel="preload" href="/css/main.css" as="style" />
        
        
            <link rel="shortcut icon" href="/images/edyo-icon.png" />
        


    
        <meta name="description" content="El podcast en el que hablamos sobre desarrollo de aplicaciones, operaciones de sistemas informáticos y todo lo relacionado con la filosofía DevOps" />
    

    
        <meta name="p:domain_verify" content=""/>
    

        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        
        

    
        <link href="http://www.entredevyops.es/index.xml" rel="alternate" type="application/rss+xml" title="Entre Dev y Ops" />
    

    
        <link rel="canonical" href="http://www.entredevyops.es/posts/fail2ban-ssh.html" />


    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "http://www.entredevyops.es/posts/fail2ban-ssh.html"
        },
        "headline": "Usando Fail2Ban para securizar SSH",
        "description": "",
        "author": {
            "@type": "Person",
            "name": " ",
            "url": "http://profiles.google.com/?rel=author",
            "image": {
              "@type": "ImageObject",
              "url": "https:",
              "height": 80,
              "width": 80
            }
        },
        "publisher": {
          "@type": "Organization",
          "@id": "http://www.entredevyops.es/",
          "name": "Entre Dev y Ops",
          "url": "http://www.entredevyops.es/",
          "logo": {
            "@type": "ImageObject",
            "url": "https:",
            "height": 80,
            "width": 80
          }
        },
        
        "image": {
          "@type": "ImageObject",
          "url": "",
          "height": 80,
          "width": 80
        },
        "datePublished": "2016-09-08",
        "dateModified": "2016-09-08",
        "wordCount": 1534,
        "keywords": ["Fail2Ban","SSH"] 
    }
    </script>


    
    <script type="text/javascript">
    
    
      var disqus_shortname = 'edyo';
      var disqus_identifier = 'http:\/\/www.entredevyops.es\/posts\/fail2ban-ssh.html';
      var disqus_title = 'Usando Fail2Ban para securizar SSH';
      var disqus_url = 'http:\/\/www.entredevyops.es\/posts\/fail2ban-ssh.html';
    
    </script>
    

    <script type="text/javascript">
      var config = {
        baseUrl: "http:\/\/www.entredevyops.es\/"
      };
    </script>

    <style>
html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,figure,footer,header,main,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figure{margin:1em 40px}a{background-color:transparent;-webkit-text-decoration-skip:objects}img{border-style:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:300;src:local("Merriweather Sans Light"),local(MerriweatherSans-Light),url(//fonts.gstatic.com/s/merriweathersans/v5/6LmGj5dOJopQKEkt88GowY_zIojJi0m4a5Z6tRh6itY.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:400;src:local("Merriweather Sans Regular"),local(MerriweatherSans-Regular),url(//fonts.gstatic.com/s/merriweathersans/v5/AKu1CjQ4qnV8MUltkAX3sL2aU247V0zTzydO4RoO9Ok.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:700;src:local("Merriweather Sans Bold"),local(MerriweatherSans-Bold),url(//fonts.gstatic.com/s/merriweathersans/v5/6LmGj5dOJopQKEkt88GowQfd-b-I5PxxcmB4_-MNcqw.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:800;src:local("Merriweather Sans ExtraBold"),local(MerriweatherSans-ExtraBold),url(//fonts.gstatic.com/s/merriweathersans/v5/6LmGj5dOJopQKEkt88GowWT7sFQ1Iz1BbpcuCPlgc9Q.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:italic;font-weight:300;src:local("Merriweather Sans Light Italic"),local(MerriweatherSans-LightItalic),url(//fonts.gstatic.com/s/merriweathersans/v5/nAqt4hiqwq3tzCecpgPmVX9UU5BmOJGkLxUCVv5VXdc.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:italic;font-weight:400;src:local("Merriweather Sans Italic"),local(MerriweatherSans-Italic),url(//fonts.gstatic.com/s/merriweathersans/v5/3Mz4hOHzs2npRMG3B1ascf0KIgDhPIHb_R-SWdtqte8.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:italic;font-weight:700;src:local("Merriweather Sans Bold Italic"),local(MerriweatherSans-BoldItalic),url(//fonts.gstatic.com/s/merriweathersans/v5/nAqt4hiqwq3tzCecpgPmVYM8pfYvjMoOxygpzLVILAs.woff) format("woff")}@font-face {font-family: 'Aldrich';font-style: normal;font-weight: 400;src: local('Aldrich Regular'), local('Aldrich-Regular'), url('//fonts.gstatic.com/s/aldrich/v8/j-NnyokbAnhXANS2iZ6Jew.woff2') format('woff2');unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215;font-style:normal}[class^="icon-"]:before{font-family:"icons";font-style:normal;font-weight:400;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-arrow-right:before{content:'\e807'}.icon-rss:before{content:'\e808'}body{font:300 1em / 1.5em 'Merriweather Sans',sans-serif;color:#595B66}a{color:inherit;text-decoration:none;font-weight:400}h1,h2{text-rendering:optimizeLegibility;color:#1F2026}h2 a{font-weight:inherit}h1{font-size:2em;line-height:1em;margin:2em 0 -.5em}h2{font-size:1.75em;line-height:1.143em;margin:2.286em 0 -.571em}p{margin:2em auto}i{font-weight:400;font-style:italic;color:#363740}img{display:block;max-width:100%;height:auto;margin:2.5em auto}body{background:#fff}.inner{max-width:48em;margin:0 auto;padding:0 1em}#wrapper{position:relative;box-sizing:border-box;width:100%;min-height:100vh;padding-bottom:6em;background:#F2F3F5}#push{transform:translate3d(0,0,0);transform-style:preserve-3d;opacity:1}#nav{position:relative;background:#fff;z-index:70;transform:translate3d(0,0,0);transform-style:preserve-3d;opacity:1}#nav:after{clear:both;content:'';display:table}#nav .nav-logo{float:left;height:2em;padding:1em;max-width:50%}#nav .nav-logo img{width:auto;max-width:none;height:2em;margin:0;border-radius:5px}#nav .nav-menu{float:right}#nav .nav-menu:after{clear:both;content:'';display:table}#nav .nav-menu a{display:block;width:1em;height:1em;line-height:1em;padding:1.5em;text-align:center;float:left}#nav .nav-menu a i:before{margin:auto}.overlay{display:none;position:fixed;left:0;top:0;width:100%;height:100%;z-index:80;display:none}.overlay:before{content:'';position:absolute;left:0;top:0;width:100%;height:100%;background:#1F2026;opacity:0;transform-style:preserve-3d}#header{position:relative;padding:4em 0}#header .inner{position:relative;z-index:2}#header .header-title{display:block;text-align:center}#header .header-name{font-family: Aldrich, sans-serif;font-weight:700;letter-spacing:-1px;display:block;line-height:1em;font-size:2em;text-decoration:none;color:#1F2026;padding:0;margin:0}#header.has-cover .header-name{color:#fff}#header .header-description{display:block;margin:1em auto 0;color:#9D9FA6;position:relative;font-weight:300}#header .header-description:after{content:'';position:absolute;height:1px;width:100px;margin-left:-50px;left:50%;top:-.5em;background:#D4D5D9}#header.has-cover .header-description{color:#fff}#header.has-cover .header-description:after{background:#fff}#header .header-cover{position:absolute;width:100%;height:100%;top:0;left:0;margin-top:-4em;padding:4em 0;background:no-repeat fixed center 100% / cover;z-index:1}#header .header-cover:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background:rgba(0,0,0,0.2)}#header .header-cover:after{content:'';position:absolute;width:100%;left:0;bottom:0;border-bottom:4px solid #19A0D7}#footer{position:absolute;width:100%;left:0;bottom:0;font-size:.75em;line-height:1.334em;background:#1F2026;color:#737580;z-index:20;transform:translate3d(0,0,0);transform-style:preserve-3d;opacity:1}#footer a{color:#9D9FA6;font-weight:400}#footer .credits{text-align:center;font-size:.75em;line-height:1.334em;padding:2.667em;overflow:auto}#footer .credits span{display:block}#footer .credits .credits-theme{float:left}#footer .credits .credits-software{float:right}.post{position:relative;z-index:20}.post .post-image{display:block;margin:0;padding:0}.post .post-image img{display:block;width:100%;height:auto;margin:0;padding:0}.post .post-meta{display:block;font-size:.75em;line-height:1.334em;font-weight:400;margin-bottom:1.334em}.post .post-title{position:relative;color:#000;font-size:2em;line-height:1.375em;font-weight:800;text-indent:-1px;margin:.25em 0 .75em}.post .post-title:before{content:'';position:absolute;left:0;bottom:-.334em;width:1em;margin-bottom:-2px;border-bottom:4px solid #19A0D7}.post .post-title a{text-decoration:none;color:inherit;font-weight:inherit}#post-index{position:relative;max-width:1200px;margin:0 auto 4em;padding:.5em;z-index:10}@keyframes fade{0%{transform:translate3d(0,3em,0);opacity:0}100%{transform:translate3d(0,0,0);opacity:1}}.post-list{position:relative}.post-list .post{float:left;width:33.3%;transform:translate3d(0,3em,0);transform-style:preserve-3d;opacity:0;animation:fade ease-out .5s forwards;animation-delay:1.4s}@media only screen and (max-width: 50em){.post-list .post{width:49.9%}}@media only screen and (max-width: 30em){.post-list .post{width:100%;float:none}}.post-list .post:nth-child(1){animation-delay:.1s}.post-list .post:nth-child(2){animation-delay:.2s}.post-list .post:nth-child(3){animation-delay:.3s}.post-list .post:nth-child(4){animation-delay:.4s}.post-list .post:nth-child(5){animation-delay:.5s}.post-list .post:nth-child(6){animation-delay:.6s}.post-list .post:nth-child(7){animation-delay:.7s}.post-list .post:nth-child(8){animation-delay:.8s}.post-list .post:nth-child(9){animation-delay:.9s}.post-list .post .inner{padding:2em;margin:.5em;max-width:none;background:#fff;box-sizing:border-box;transform:scale(1);transform-style:preserve-3d}@media only screen and (max-width: 50em){.post-list .post .inner{padding:1em}}.post-list .post .post-link{position:absolute;left:0;top:0;width:100%;height:100%;z-index:10}.post-list .post .post-image{position:relative;margin:-2em -2em 0;overflow:hidden;background:#19A0D7}@media only screen and (max-width: 50em){.post-list .post .post-image{margin:-1em -1em 0}}.post-list .post .post-image img{transform:scale(1);transform-style:preserve-3d;opacity:1}.post-list .post .post-image:after{content:'';position:absolute;left:-5%;bottom:-2.5em;width:110%;height:4em;background:#fff;border-top:4px solid #19A0D7;box-shadow:0 0 2em rgba(0,0,0,0.2);transform:rotate(5deg)}.post-list .post .post-title{font-size:1.5em;line-height:1.167em}.post-list .post .post-excerpt{margin:0}.post-list .post .post-more{display:block;margin-top:1.5em}.post-list .post .post-more a{display:inline-block;font-size:.875em;line-height:1.143em;font-weight:400;color:#363740}.post-list .post .post-more a i{color:#0e77a0}.pagination{min-height:3em;margin:4em auto 2em;padding:0;position:relative}.pagination .pagination-item{position:relative;display:block;height:3em;line-height:3em;padding:0 1em;text-align:center;text-decoration:none;font-weight:700;color:#363740;border:1px solid #19A0D7;border-radius:4em;z-index:60}.pagination .pagination-item i{position:relative}@media only screen and (max-width: 30em){.pagination .pagination-item{width:4em;height:4em;line-height:4em;margin-top:-.5em;padding:0!important}.pagination .pagination-item i{font-size:1.5em}.pagination .pagination-item>span{display:none}}.pagination .pagination-prev{float:right}.pagination .pagination-prev i{right:-.05em}.pagination .pagination-info{display:block;left:0;top:0;height:3em;line-height:3em;position:absolute;text-align:center;width:100%;z-index:50;color:#9D9FA6}#loader-wrapper{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000}#loader{display:block;position:relative;left:50%;top:50%;width:150px;height:150px;margin:-75px 0 0 -75px;border-radius:50%;border:3px solid transparent;border-top-color:#19A0D7;animation:spin 2s linear infinite}#loader:before{content:"";position:absolute;top:5px;left:5px;right:5px;bottom:5px;border-radius:50%;border:3px solid transparent;border-top-color:#0e77a0;animation:spin 3s linear infinite}#loader:after{content:"";position:absolute;top:15px;left:15px;right:15px;bottom:15px;border-radius:50%;border:3px solid transparent;border-top-color:#D4D5D9;animation:spin 1.5s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>


    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
    <script>
    window.addEventListener("load", function(){
    window.cookieconsent.initialise({
    "palette": {
        "popup": {
        "background": "#222222"
        },
        "button": {
        "background": "#19a0d7"
        }
    },
    "content": {
        "message": "Esta web utiliza cookies de terceros para mejorar la experiencia de la web y recopilar datos de uso. Si continúas navegando, consideramos que aceptas su uso.",
        "dismiss": "Entendido",
        "link": "Política de cookies",
        "href": "politica-cookies.html"
    }
    })});
    </script>

    </head>
    <body class="home-template">
      <div id="loader-wrapper">
        <div id="loader"></div>
      </div>
      <section id="wrapper" style="display: none;">
        <div id="ajax-container">
          <nav id="nav" class="nav">
            <div class="nav-logo">
               <a href="http://www.entredevyops.es/">
                  
                    <img src="/images/edyo-logo.png" alt="Logo"/>
                  
              </a>
            </div>
            <div id="main-menu" class="nav-menu">
              
                <a class="menu subscription" data-action="subscription"
                    data-target="subscription" title="Suscríbete al Podcast">Suscríbete</a>
              
              <a class="nav-social" target="_blank" href="https://twitter.com/entredevyops" title="Entre Dev y Ops en Twitter"><i class="fab fa-twitter"></i></a>
              <a class="nav-social" target="_blank" href="https://t.me/entredevyops" title="Entre Dev y Ops en Telegram"><i class="fab fa-telegram-plane"></i></a>
              <a class="nav-social" target="_blank" href="https://github.com/edyo" title="Entre Dev y Ops en GitHub"><i class="fab fa-github"></i></a>
              <a id="search-button" onclick="$('#search-form').toggle();" title="Buscar"><i class="fas fa-search"></i></a>
              <form id="search-form" method="get" role="search" action="https://google.es/search">
                <input type="hidden" name="as_sitesearch" value="http://www.entredevyops.es/">
                <input type="text" name="q" maxlength="255" placeholder="Buscar..." class="form-control">
                <input type="submit" value="Buscar">
              </form>
              
                
              
              
                <a id="main-menu-button" class="menu" data-action="menu" data-target="menu"
                    title="Menú"><i class="fas fa-bars"></i></a>
              
            </div>
          </nav>


<main class="content" role="main">
    <article class="post">
        <div class="inner">

            <div id="push">

                <header class="post-header">
                
                    <span class="post-meta">
                        <span class="post-date">8 Sep 2016</span> <span class="reading-time">| <span class="estimated-reading-time">8 min.</span> (<span class="word-count">1534</span> palabras)</span></span>
                    </span>
                <div class="clear"></div>
                
                <h1 class="post-title">Usando Fail2Ban para securizar SSH</h1>
              </header>

              <section class="post-content">
                
                  <p><img src='/images/796bbae0-6fd7-11e6-91dc-feb4e6aa9afa.jpg' alt='Fail2Ban' class='align-left' height='80' width='200'/></p>

<p>Hace poco realizando tareas de mantenimiento en mi servidor personal vi varios mensajes en los logs que no me gustaron nada: <em>Failed password for root from 121.18.238.22 port 40618 ssh2</em>.</p>

<p>Claramente mi servidor estaba bajo un ataque para conseguir acceso SSH.</p>

<p></p>

<h1 id="introducción">Introducción</h1>

<p>En principio fue algo que no me preocupó, por lo que vi en los mensajes estaban intentando acceder con el usuario root y tenía el login deshabilitado, por tanto todo intento sería en vano. Pero igualmente es algo que no se tenía que tomar a la ligera, e igual que tenía ese servicio bajo ataque podría suceder con cualquier otro, sin olvidar que depende del origen del ataque podrían llegar a saturar el SSH y perder la gestión de mi máquina.</p>

<p>Para &ldquo;protegerme&rdquo; de esta situación me planteé dos opciones:</p>

<ol>
<li>Acudir a mi proveedor de servicios y contratar algún sistema de <a href="https://es.wikipedia.org/wiki/Sistema_de_detecci%C3%B3n_de_intrusos" target="_blank">IDS</a> con el coste que ello supone.</li>
<li>Montarme alguna solución en el propio servidor para controlar estas situaciones.</li>
</ol>

<p>Ya que se trataba de mi servidor personal, y no contiene ninguna información o servicio que considere crítico, me decanté por esta segunda opción, pero mi recomendación para entornos productivos es que os vayáis a la primera y siempre podéis complementarla con alguna otra solución.</p>

<p>Básicamente lo que quería era bloquear el tráfico de ciertas IPs a ciertos servicios y puertos. Esto lo podría hacer activando el firewall en el servidor, pero el problema es que este tipo de ataques no siempre provienen del mismo origen. Normalmente se suele utilizar diversos orígenes para evitar ser bloqueados, por tanto, necesitaba algún tipo de producto que, sin realizar análisis del tráfico que podría realizar un IDS, me permitiera ir bloqueando dinámicamente los accesos. La solución: <a href="http://www.fail2ban.org" target="_blank">Fail2Ban</a>.</p>

<p><a href="http://www.fail2ban.org" target="_blank">Fail2Ban</a> es un software open source programado en <a href="https://www.python.org/" target="_blank">Python</a> que escanea ficheros de log y detecta patrones que pueden ser identificados como &ldquo;malvados&rdquo; (p.e. intentos consecutivos de login como usuario root por ssh ;-) ) y bloquea las IPs mediante el firewall interno del servidor. También lo podemos configurar para realizar alguna otra acción como, por ejemplo, enviar un email. De base ya viene preconfigurado para soportar varios servidores (apache, ssh, nginx, etc&hellip;) pero también podemos configurar uno específico.</p>

<p>#Instalación</p>

<p>A continuación os paso a explicar el proceso de instalación y una pequeña introducción a la configuración para proteger el servicio SSH. El taller lo iré realizando en una máquina virtual CentOS 6.8 pero la iré complementando con salidas y configuraciones de mi máquina pública para que se pueda ver el resultado en un entorno &ldquo;real&rdquo;. Todos los comandos tienen que ser realizados con el usuario root.</p>

<p><a href="http://www.fail2ban.org" target="_blank">Fail2Ban</a> no se encuentra disponible en los repositorios base CentOS y será necesario que configuremos los repositorios de EPEL con el siguiente comando:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">[root@localhost ~]<span style="color:#008000"># rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
</span><span style="color:#008000"></span>Recuperando http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
advertencia:/var/tmp/rpm-tmp.bkyK0z: CabeceraV3 RSA/SHA256 Signature, ID de clave 0608b895: NOKEY
Preparando...               <span style="color:#008000">########################################### [100%]
</span><span style="color:#008000"></span>   1:epel-release           ########################################### [100%]</code></pre></div>
<p>Ahora ya podemos ejecutar la instalación con yum</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">[root@localhost ~]<span style="color:#008000"># yum install fail2ban -y
</span><span style="color:#008000"></span>Complementos cargados:fastestmirror
Configurando el proceso de instalación
Loading mirror speeds from cached hostfile
epel/metalink                                                                                                                                                                                                      |  21 kB     00:00
 * base: centos.cadt.com
 * epel: epel.besthosting.ua
 * extras: centos.cadt.com
 * updates: centos.cadt.com
epel                                                                                                                                                                                                               | 4.3 kB     00:00
epel/primary_db                                                                                                                                                                                                    | 5.0 MB     00:12
Resolviendo dependencias
--&gt; Ejecutando prueba de transacción
---&gt; Package fail2ban.noarch 0:0.9.3-1.el6.1 will be instalado
--&gt; Procesando dependencias: python-inotify para el paquete: fail2ban-0.9.3-1.el6.1.noarch
--&gt; Procesando dependencias: ipset para el paquete: fail2ban-0.9.3-1.el6.1.noarch
--&gt; Procesando dependencias: gamin-python para el paquete: fail2ban-0.9.3-1.el6.1.noarch
--&gt; Procesando dependencias: ed para el paquete: fail2ban-0.9.3-1.el6.1.noarch
--&gt; Ejecutando prueba de transacción
---&gt; Package ed.i686 0:1.1-3.3.el6 will be instalado
---&gt; Package gamin-python.i686 0:0.1.10-9.el6 will be instalado
---&gt; Package ipset.i686 0:6.11-4.el6 will be instalado
--&gt; Procesando dependencias: libmnl.so.0(LIBMNL_1.0) para el paquete: ipset-6.11-4.el6.i686
--&gt; Procesando dependencias: libmnl.so.0 para el paquete: ipset-6.11-4.el6.i686
---&gt; Package python-inotify.noarch 0:0.9.1-1.el6 will be instalado
--&gt; Ejecutando prueba de transacción
---&gt; Package libmnl.i686 0:1.0.2-3.el6 will be instalado
--&gt; Resolución de dependencias finalizada

Dependencias resueltas

==========================================================================================================================================================================================================================================
 Paquete                                                      Arquitectura                                         Versión                                                       Repositorio                                        Tamaño
==========================================================================================================================================================================================================================================
Instalando:
 fail2ban                                                     noarch                                               0.9.3-1.el6.1                                                 epel                                               419 k
Instalando para las dependencias:
 ed                                                           i686                                                 1.1-3.3.el6                                                   base                                                70 k
 gamin-python                                                 i686                                                 0.1.10-9.el6                                                  base                                                33 k
 ipset                                                        i686                                                 6.11-4.el6                                                    base                                                63 k
 libmnl                                                       i686                                                 1.0.2-3.el6                                                   base                                                22 k
 python-inotify                                               noarch                                               0.9.1-1.el6                                                   epel                                                50 k

Resumen de la transacción
==========================================================================================================================================================================================================================================
Instalar       6 Paquete(s)

Tamaño total de la descarga: 656 k
Tamaño instalado: 2.0 M
Descargando paquetes:
(1/6): ed-1.1-3.3.el6.i686.rpm                                                                                                                                                                                     |  70 kB     00:00
(2/6): fail2ban-0.9.3-1.el6.1.noarch.rpm                                                                                                                                                                           | 419 kB     00:01
(3/6): gamin-python-0.1.10-9.el6.i686.rpm                                                                                                                                                                          |  33 kB     00:00
(4/6): ipset-6.11-4.el6.i686.rpm                                                                                                                                                                                   |  63 kB     00:00
(5/6): libmnl-1.0.2-3.el6.i686.rpm                                                                                                                                                                                 |  22 kB     00:00
(6/6): python-inotify-0.9.1-1.el6.noarch.rpm                                                                                                                                                                       |  50 kB     00:00
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Total                                                                                                                                                                                                     154 kB/s | 656 kB     00:04
advertencia:rpmts_HdrFromFdno: CabeceraV3 RSA/SHA1 Signature, ID de clave c105b9de: NOKEY
Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
Importing GPG key 0xC105B9DE:
 Userid : CentOS-6 Key (CentOS 6 Official Signing Key) &lt;centos-6-key@centos.org&gt;
 Package: centos-release-6-8.el6.centos.12.3.i686 (@anaconda-CentOS-201605211917.i386/6.8)
 From   : /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
warning: rpmts_HdrFromFdno: Header V3 RSA/SHA256 Signature, key ID 0608b895: NOKEY
Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6
Importing GPG key 0x0608B895:
 Userid : EPEL (6) &lt;epel@fedoraproject.org&gt;
 Package: epel-release-6-8.noarch (installed)
 From   : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6
Ejecutando el rpm_check_debug
Ejecutando prueba de transacción
La prueba de transacción ha sido exitosa
Ejecutando transacción
Advertencia: Las bases de datos (RPMDB) han sido modificadas por un elemento ajeno a yum.
  Instalando    : python-inotify-0.9.1-1.el6.noarch                                                                                                                                                                                   1/6
  Instalando    : ed-1.1-3.3.el6.i686                                                                                                                                                                                                 2/6
  Instalando    : gamin-python-0.1.10-9.el6.i686                                                                                                                                                                                      3/6
  Instalando    : libmnl-1.0.2-3.el6.i686                                                                                                                                                                                             4/6
  Instalando    : ipset-6.11-4.el6.i686                                                                                                                                                                                               5/6
  Instalando    : fail2ban-0.9.3-1.el6.1.noarch                                                                                                                                                                                       6/6
  Verifying     : libmnl-1.0.2-3.el6.i686                                                                                                                                                                                             1/6
  Verifying     : fail2ban-0.9.3-1.el6.1.noarch                                                                                                                                                                                       2/6
  Verifying     : gamin-python-0.1.10-9.el6.i686                                                                                                                                                                                      3/6
  Verifying     : ipset-6.11-4.el6.i686                                                                                                                                                                                               4/6
  Verifying     : python-inotify-0.9.1-1.el6.noarch                                                                                                                                                                                   5/6
  Verifying     : ed-1.1-3.3.el6.i686                                                                                                                                                                                                 6/6

Instalado:
  fail2ban.noarch 0:0.9.3-1.el6.1

Dependencia(s) instalada(s):
  ed.i686 0:1.1-3.3.el6                   gamin-python.i686 0:0.1.10-9.el6                   ipset.i686 0:6.11-4.el6                   libmnl.i686 0:1.0.2-3.el6                   python-inotify.noarch 0:0.9.1-1.el6

¡Listo!</code></pre></div>
<p>El programa se compone de dos partes importantes:
* La parte de servidor (daemon), que estará vigilando los diferentes ficheros de log en busca de patrones y creando los bloqueos necesarios.
* La parte cliente, que servirá para interactuar con el servidor y hacer consultas (p.e. número de bloqueos) o incluso aplicar configuraciones &ldquo;en caliente&rdquo;.</p>

<p>La estructura de directorios y ficheros que genera la instalación es la siguiente:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">[root@localhost /]<span style="color:#008000"># ls -lrt /etc/fail2ban/
</span><span style="color:#008000"></span>total 60
-rw-r--r--. 1 root root   290 ago  1  2015 paths-osx.conf
-rw-r--r--. 1 root root  1174 ago  1  2015 paths-freebsd.conf
-rw-r--r--. 1 root root   743 ago  1  2015 paths-fedora.conf
-rw-r--r--. 1 root root   642 ago  1  2015 paths-debian.conf
-rw-r--r--. 1 root root  1939 ago  1  2015 paths-common.conf
-rw-r--r--. 1 root root 18558 oct 17  2015 jail.conf
-rw-r--r--. 1 root root  2313 oct 17  2015 fail2ban.conf
drwxr-xr-x. 2 root root  4096 oct 17  2015 jail.d
drwxr-xr-x. 2 root root  4096 oct 17  2015 fail2ban.d
drwxr-xr-x. 3 root root  4096 sep  5 15:13 filter.d
drwxr-xr-x. 2 root root  4096 sep  5 15:13 action.d</code></pre></div>
<p>Ahora ha llegado el momento de configurar una prisión (jail en <a href="http://www.fail2ban.org" target="_blank">Fail2Ban</a>) que básicamente consiste en definir un servicio a monitorizar y unas acciones a realizar. Como he dicho nos interesa controlar el SSH, para esto crearemos el fichero jail.local en la misma ruta:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">touch /etc/fail2ban/jail.local</code></pre></div>
<p>Y pondremos el siguiente contenido:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">[DEFAULT]
<span style="color:#008000"># Tiempo que bloqueramos la IP: 3600 segundos (1 hora)
</span><span style="color:#008000"></span>bantime = 3600

<span style="color:#008000"># La acción que de bloqueo será a traves del firewall interno (iptables)
</span><span style="color:#008000"></span>banaction = iptables-multiport

[sshd] <span style="color:#008000">#activamos el jail para el demonio de ssh
</span><span style="color:#008000"></span>enabled = true</code></pre></div>
<p>Arrancamos el demonio:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">[root@localhost /]<span style="color:#008000"># /etc/init.d/fail2ban start
</span><span style="color:#008000"></span>Iniciando fail2ban:                                        [  OK  ]</code></pre></div>
<p>Consultamos, a través del cliente, que jails tenemos activos:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">[root@localhost /]<span style="color:#008000"># fail2ban-client status
</span><span style="color:#008000"></span>Status
|- Number of jail:      1
<span style="color:#a31515">`</span>- Jail list:   sshd</code></pre></div>
<p>Y podemos consultar en detalle el estado de ese jail:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">[root@localhost /]<span style="color:#008000"># fail2ban-client status sshd
</span><span style="color:#008000"></span>Status <span style="color:#00f">for</span> the jail: sshd
|- Filter
|  |- Currently failed: 0
|  |- Total failed:     0
|  <span style="color:#a31515">`</span>- File list:        /var/log/secure
<span style="color:#a31515">`</span>- Actions
   |- Currently banned: 0
   |- Total banned:     0
   <span style="color:#a31515">`</span>- Banned IP list:</code></pre></div>
<p>En este caso nos indica que no ha localizado ningún fallo de autentificación, que monitoriza el fichero /var/log/secure (donde deja las trazas por defecto el demonio sshd) y que no ha realizado ninguna acción.</p>

<p>A continuación os voy a dejar la salida del mismo comando pero de mi servidor público que lleva unos 15 días funcionando para que comparéis los resultados:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">Status <span style="color:#00f">for</span> the jail: sshd
|- Filter
|  |- Currently failed: 0
|  |- Total failed:     6445
|  <span style="color:#a31515">`</span>- File list:        /var/log/secure
<span style="color:#a31515">`</span>- Actions
   |- Currently banned: 0
   |- Total banned:     562
   <span style="color:#a31515">`</span>- Banned IP list:</code></pre></div>
<p>Podéis ver que ha localizado 6445 fallos y ha bloqueado un total de 562 IPs. Actualmente no tiene ninguna IP bloqueada (se estarán cansado ;-) ).</p>

<p>#A tener en cuenta</p>

<ul>
<li>Para evitar posibles bloqueos no deseados (por ejemplo el de nuestra IP de acceso) podemos definir un rango de exclusión para que se ignoren los orígenes de dichas IPs con el parámetro <em>ignoreip</em></li>
<li>Mi recomendación es definir tiempos de bloqueo bajos para que, en caso de accidente, podamos recuperar el acceso a nuestro servidor. He comprobado que una hora es suficientemente disuasorio.</li>
<li>Podéis ver los jails disponibles listando el contenido del fichero <em>/etc/fail2ban/jail.conf</em> y hacer lo mismo que hemos hecho para el sshd.</li>
<li>Recordad tener activado los servicios de <em>iptables</em> y <em>fail2ban</em>.</li>
<li>Os dejo un ejemplo de configuración para el servidor web <a href="https://www.nginx.com/resources/wiki/" target="_blank">nginx</a> dando servicio a diferentes dominios y con diferentes ficheros de log:
```Bash
[nginx-botsearch]</li>
</ul>

<p>enabled = true
port     = http,https
logpath = /var/log/nginx/error.log
        /var/log/nginx/*/error.log
maxretry = 2
```</p>

<p>Espero que os sea útil y espero vuestro feedback.</p>
              </section>

              <footer class="post-footer">
                  <div class="post-tags">
            
            
                <a href="http://www.entredevyops.es/tags/fail2ban.html">Fail2Ban</a>
            
                <a href="http://www.entredevyops.es/tags/ssh.html">SSH</a>
            
            
                  </div>
                
                    <div class="post-share">
                        <a class="fas fa-twitter" href="https://twitter.com/share?text=Usando%20Fail2Ban%20para%20securizar%20SSH&url=http%3a%2f%2fwww.entredevyops.es%2fposts%2ffail2ban-ssh.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span>Twitter</span>
                        </a>
                        <a class="fas fa-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fwww.entredevyops.es%2fposts%2ffail2ban-ssh.html&title=Usando%20Fail2Ban%20para%20securizar%20SSH&summary=%3cp%3e%3cimg%20src%3d%27%2fimages%2f796bbae0-6fd7-11e6-91dc-feb4e6aa9afa.jpg%27%20alt%3d%27Fail2Ban%27%20class%3d%27align-left%27%20height%3d%2780%27%20width%3d%27200%27%2f%3e%3c%2fp%3e%0a%0a%3cp%3eHace%20poco%20realizando%20tareas%20de%20mantenimiento%20en%20mi%20servidor%20personal%20vi%20varios%20mensajes%20en%20los%20logs%20que%20no%20me%20gustaron%20nada%3a%20%3cem%3eFailed%20password%20for%20root%20from%20121.18.238.22%20port%2040618%20ssh2%3c%2fem%3e.%3c%2fp%3e%0a%0a%3cp%3eClaramente%20mi%20servidor%20estaba%20bajo%20un%20ataque%20para%20conseguir%20acceso%20SSH.%3c%2fp%3e%0a%0a%3cp%3e%3c%2fp%3e" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=550');return false;">
                            <span>LinkedIn</span>
                        </a>
                    </div>
            
              </footer>

            
                <aside class="post-comments">
    
    
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
</aside>

            
            </div>

            <nav class="post-nav">
                
                    <a class="post-nav-item post-nav-next" href="http://www.entredevyops.es/posts/publicacion-estatica-ii.html">
                        <section class="post-nav-teaser">
                            <span class="post-nav-icon"><i class="fas fa-chevron-left"></i></span>
                            <span class="post-nav-info">
                                <h4 class="post-nav-title">Publicación estática (II)</h4>
                            </span>
                        </section>
                    </a>
                
                
                    <a class="post-nav-item post-nav-prev" href="http://www.entredevyops.es/posts/paginas-estaticas-amazon-2.html">
                        <section class="post-nav-teaser">
                            <span class="post-nav-icon"><i class="fas fa-chevron-right"></i></span>
                            <span class="post-nav-info">
                                <h4 class="post-nav-title">Páginas estáticas en Amazon - 2</h4>
                            </span>
                        </section>
                    </a>
                
                <div class="clear"></div>
            </nav>

        </div>
    </article>
</main>

                <div id="body-class" style="display: none;"></div>
                <footer id="footer">
                    <section class="credits">
                        
                        <span class="credits-license"><i class="fas fa-copyright"></i> 2013-2018 Entre Dev y Ops, licencia <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.es_ES"><i class="fab fa-creative-commons"></i> BY-NC-SA 3.0</a>
                        
                        
                        — <a href="politica-cookies.html">Política de cookies</a>
                        
                    </span>
                    <span class="credits-software">Publicado con
                        <a href="http://gohugo.io" target="_blank" rel="nofollow">Hugo</a>,
                        tema basado en <a href="https://github.com/zenithar/hugo-theme-bleak" target="_blank" rel="nofollow">Bleak</a>
                        por <a href="http://zutrinken.com" target="_blank" rel="nofollow">zutrinken</a></span>
                    </section>
                </footer>
                
<div id="subscription" data-target="subscription">
    <div class="menu-header">
        <span class="menu-label">Suscríbete</span>
        <a class="menu-close" data-action="subscription" data-target="subscription"></a>
    </div>

    <div class="menu-list">
        
        
        <li class="menu-list-item">
            
            <a target="_blank" href="http://feedpress.me/edyo">Podcast RSS</a>
        </li>
        
        
        <li class="menu-list-item">
            
            <a target="_blank" href="https://www.ivoox.com/podcast-entre-dev-y-ops-podcast_sq_f1112910_1.html">Podcast en iVoox</a>
        </li>
        
        
        <li class="menu-list-item">
            
            <a target="_blank" href="https://itunes.apple.com/es/podcast/entredevyops-podcast/id866788492">Podcast en iTunes</a>
        </li>
        
        
        <li class="menu-list-item">
            
            <a target="_blank" href="/rss.xml">Web RSS</a>
        </li>
        
    </div>

</div>


                
<div id="menu" data-target="menu">
    <div class="menu-header">
        <span class="menu-label">Menú</span>
        <a class="menu-close" data-action="menu" data-target="menu"></a>
    </div>

    <div class="menu-list">
        
        
        <li class="menu-list-item">
            
            <a class="home current js-ajax-link" href="/podcasts.html">Episodios podcast</a>
        </li>
        
        
        <li class="menu-list-item">
            
            <a class="home current js-ajax-link" href="/posts.html">Artículos</a>
        </li>
        
        
        <li class="menu-list-item">
            
            <a class="home current js-ajax-link" href="/equipo.html">Equipo</a>
        </li>
        
        <li class="menu-list-item menu-list-social">
            <a href="https://twitter.com/entredevyops" title="Entre Dev y Ops en Twitter"><i class="fab fa-twitter"></i></a>
            <a href="https://t.me/entredevyops" title="Entre Dev y Ops en Telegram"><i class="fab fa-telegram-plane"></i></a>
            <a href="https://github.com/edyo" title="Entre Dev y Ops en GitHub"><i class="fab fa-github"></i></a>
        </li>
    </div>

</div>


                
                <div class="overlay"></div>
            </div>
        </section>

    <script async src="/js/main.js"></script>

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-25613214-1', 'auto');
        ga('send', 'pageview');
    </script>
    



  <noscript><link rel="stylesheet" href="/css/main.css"></noscript>
</body>
</html>

